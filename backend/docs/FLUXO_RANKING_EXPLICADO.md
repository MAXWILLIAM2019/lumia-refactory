# üîÑ Fluxo Completo do Sistema de Ranking - A "M√°gica" Explicada

## üéØ Vis√£o Geral do Fluxo

O sistema de ranking funciona em **3 n√≠veis**:
1. **N√≠vel de Aplica√ß√£o** (Node.js + node-cron)
2. **N√≠vel de Banco** (PostgreSQL + Fun√ß√µes)
3. **N√≠vel de Dados** (View + Tabelas)

## üèóÔ∏è Arquitetura do Fluxo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FLUXO COMPLETO DO RANKING                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   APLICA√á√ÉO     ‚îÇ    ‚îÇ     BANCO       ‚îÇ    ‚îÇ     DADOS       ‚îÇ
‚îÇ   (Node.js)     ‚îÇ    ‚îÇ  (PostgreSQL)   ‚îÇ    ‚îÇ   (Tabelas)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ 1. Inicia Scheduler   ‚îÇ                       ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ 2. Agenda Jobs        ‚îÇ                       ‚îÇ
         ‚îÇ    (08:00, 14:00,     ‚îÇ                       ‚îÇ
         ‚îÇ     20:00, 02:00)     ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ 3. Executa Job        ‚îÇ                       ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ 4. Chama Fun√ß√£o       ‚îÇ
         ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ 5. Consulta View      ‚îÇ
         ‚îÇ                       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ 6. Calcula Ranking    ‚îÇ
         ‚îÇ                       ‚îÇ    e Atualiza Tabela  ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ 7. Recebe Resultado   ‚îÇ                       ‚îÇ
         ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îÇ 8. Log Estat√≠sticas   ‚îÇ                       ‚îÇ
         ‚îÇ                       ‚îÇ                       ‚îÇ
```

## üöÄ 1. N√≠vel de Aplica√ß√£o (Node.js)

### **Classe: `JobScheduler`** (`backend/src/jobs/scheduler.js`)

```javascript
class JobScheduler {
  iniciar() {
    // Job 1: Atualiza√ß√£o 3x ao dia
    const rankingJob1 = cron.schedule('0 8 * * *', async () => {
      await rankingJob.executarAtualizacao();
    });
    
    const rankingJob2 = cron.schedule('0 14 * * *', async () => {
      await rankingJob.executarAtualizacao();
    });
    
    const rankingJob3 = cron.schedule('0 20 * * *', async () => {
      await rankingJob.executarAtualizacao();
    });
    
    // Job 2: Limpeza semanal
    const limpezaJob = cron.schedule('0 2 * * 1', async () => {
      await rankingJob.executarLimpeza();
    });
  }
}
```

**Responsabilidades:**
- ‚úÖ **Agendar jobs** com node-cron
- ‚úÖ **Controlar execu√ß√£o** (evitar sobreposi√ß√£o)
- ‚úÖ **Gerenciar timezone** (America/Sao_Paulo)
- ‚úÖ **Log de execu√ß√£o** e status

### **Classe: `RankingJob`** (`backend/src/jobs/rankingJob.js`)

```javascript
class RankingJob {
  async executarAtualizacao() {
    // 1. Verifica se j√° est√° rodando
    if (this.isRunning) return;
    
    // 2. Marca como executando
    this.isRunning = true;
    
    // 3. Chama fun√ß√£o PostgreSQL
    await db.query('SELECT public.atualizar_ranking_semanal()');
    
    // 4. Log de estat√≠sticas
    await this.logEstatisticas();
    
    // 5. Libera execu√ß√£o
    this.isRunning = false;
  }
}
```

**Responsabilidades:**
- ‚úÖ **Executar atualiza√ß√£o** do ranking
- ‚úÖ **Chamar fun√ß√µes** PostgreSQL
- ‚úÖ **Controlar concorr√™ncia** (evitar jobs simult√¢neos)
- ‚úÖ **Log de performance** e estat√≠sticas
- ‚úÖ **Tratamento de erros**

## üóÑÔ∏è 2. N√≠vel de Banco (PostgreSQL)

### **Fun√ß√£o: `atualizar_ranking_semanal()`**

```sql
CREATE OR REPLACE FUNCTION public.atualizar_ranking_semanal()
RETURNS void AS $$
DECLARE
    v_semana_inicio DATE;
    v_semana_fim DATE;
    v_posicao_atual INTEGER := 1;
    aluno_record RECORD;
BEGIN
    -- 1. Calcula per√≠odo da semana
    v_semana_inicio := DATE_TRUNC('week', CURRENT_DATE)::DATE;
    v_semana_fim := (v_semana_inicio + INTERVAL '6 days')::DATE;
    
    -- 2. Limpa ranking atual
    DELETE FROM public.ranking_semanal 
    WHERE ranking_semanal.semana_inicio = v_semana_inicio;
    
    -- 3. Consulta view e insere novos dados
    FOR aluno_record IN 
        SELECT * FROM public.vw_desempenho_alunos
    LOOP
        INSERT INTO public.ranking_semanal (
            id_usuario, nome_usuario, email_usuario,
            total_questoes, total_acertos, percentual_acerto, pontuacao_final,
            posicao, semana_inicio, semana_fim, ultima_atualizacao
        ) VALUES (
            aluno_record.idusuario, aluno_record.nome_usuario, aluno_record.email_usuario,
            aluno_record.total_questoes, aluno_record.total_acertos,
            aluno_record.percentual_acerto, aluno_record.pontuacao_final,
            v_posicao_atual, v_semana_inicio, v_semana_fim, CURRENT_TIMESTAMP
        );
        
        v_posicao_atual := v_posicao_atual + 1;
    END LOOP;
    
    -- 4. Log de sucesso
    RAISE NOTICE 'Ranking atualizado: % alunos, semana % a %', 
        v_posicao_atual - 1, v_semana_inicio, v_semana_fim;
END;
$$ LANGUAGE plpgsql;
```

**Responsabilidades:**
- ‚úÖ **Calcular per√≠odo** da semana atual
- ‚úÖ **Limpar dados** antigos da semana
- ‚úÖ **Consultar view** para obter desempenho
- ‚úÖ **Inserir novos dados** na tabela
- ‚úÖ **Calcular posi√ß√µes** do ranking
- ‚úÖ **Log de execu√ß√£o** no PostgreSQL

### **Fun√ß√£o: `limpar_ranking_antigo()`**

```sql
CREATE OR REPLACE FUNCTION public.limpar_ranking_antigo()
RETURNS void AS $$
BEGIN
    -- Remove rankings de semanas anteriores (mant√©m apenas 2 semanas)
    DELETE FROM public.ranking_semanal 
    WHERE semana_inicio < DATE_TRUNC('week', CURRENT_DATE) - INTERVAL '1 week';
    
    RAISE NOTICE 'Ranking antigo limpo em %', CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;
```

**Responsabilidades:**
- ‚úÖ **Limpar dados** antigos (manter apenas 2 semanas)
- ‚úÖ **Liberar espa√ßo** no banco
- ‚úÖ **Log de limpeza**

## üìä 3. N√≠vel de Dados (View + Tabelas)

### **View: `vw_desempenho_alunos`**

```sql
CREATE VIEW public.vw_desempenho_alunos AS
SELECT 
    u.idusuario,
    u.nome as nome_usuario,
    u.login as email_usuario,
    COALESCE(SUM(m."totalQuestoes"), 0) as total_questoes,
    COALESCE(SUM(m."questoesCorretas"), 0) as total_acertos,
    CASE 
        WHEN COALESCE(SUM(m."totalQuestoes"), 0) > 0 
        THEN ROUND(
            (COALESCE(SUM(m."questoesCorretas"), 0) * 100.0) / 
            COALESCE(SUM(m."totalQuestoes"), 1), 2
        )
        ELSE 0.00
    END as percentual_acerto,
    ROUND(
        (COALESCE(SUM(m."questoesCorretas"), 0) * 10.0) + 
        (CASE 
            WHEN COALESCE(SUM(m."totalQuestoes"), 0) > 0 
            THEN (COALESCE(SUM(m."questoesCorretas"), 0) * 100.0) / 
            COALESCE(SUM(m."totalQuestoes"), 1) * 0.5
            ELSE 0.00
        END) +
        (COALESCE(SUM(m."totalQuestoes"), 0) * 0.1), 2
    ) as pontuacao_final
FROM public.usuario u
LEFT JOIN public."AlunoPlanos" ap ON u.idusuario = ap.idusuario AND ap.ativo = true
LEFT JOIN public."Planos" p ON ap."PlanoId" = p.id
LEFT JOIN public."Sprints" s ON p.id = s."PlanoId"
LEFT JOIN public."Meta" m ON s.id = m."SprintId" 
    AND m.status = 'Conclu√≠da'
    AND m."updatedAt" >= DATE_TRUNC('week', CURRENT_DATE)
    AND m."updatedAt" < DATE_TRUNC('week', CURRENT_DATE) + INTERVAL '7 days'
WHERE u.situacao = true
GROUP BY u.idusuario, u.nome, u.login
HAVING COALESCE(SUM(m."totalQuestoes"), 0) > 0
ORDER BY pontuacao_final DESC, total_questoes DESC, percentual_acerto DESC;
```

**Responsabilidades:**
- ‚úÖ **Calcular m√©tricas** em tempo real
- ‚úÖ **Filtrar por semana** atual
- ‚úÖ **Aplicar f√≥rmula** de pontua√ß√£o
- ‚úÖ **Ordenar por desempenho**
- ‚úÖ **Filtrar apenas** alunos ativos com atividades

### **Tabela: `ranking_semanal`**

```sql
CREATE TABLE public.ranking_semanal (
    id_ranking SERIAL PRIMARY KEY,
    id_usuario INTEGER NOT NULL REFERENCES public.usuario(idusuario) ON DELETE CASCADE,
    nome_usuario VARCHAR(100) NOT NULL,
    email_usuario VARCHAR(120) NOT NULL,
    total_questoes INTEGER DEFAULT 0,
    total_acertos INTEGER DEFAULT 0,
    percentual_acerto DECIMAL(5,2) DEFAULT 0.00,
    pontuacao_final DECIMAL(8,2) DEFAULT 0.00,
    posicao INTEGER,
    semana_inicio DATE NOT NULL,
    semana_fim DATE NOT NULL,
    ultima_atualizacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(id_usuario, semana_inicio)
);
```

**Responsabilidades:**
- ‚úÖ **Armazenar ranking** calculado
- ‚úÖ **Manter hist√≥rico** semanal
- ‚úÖ **Permitir consultas** r√°pidas
- ‚úÖ **Garantir unicidade** por usu√°rio/semana

## ‚ö° 4. Fluxo Detalhado de Execu√ß√£o

### **Cen√°rio: Job executando √†s 14:00**

```
1. üïê 14:00:00 - node-cron dispara o job
   ‚îî‚îÄ JobScheduler.executarAtualizacao()

2. üîç 14:00:01 - Verifica se j√° est√° rodando
   ‚îî‚îÄ if (this.isRunning) return;

3. üîí 14:00:02 - Marca como executando
   ‚îî‚îÄ this.isRunning = true;

4. üìû 14:00:03 - Chama fun√ß√£o PostgreSQL
   ‚îî‚îÄ db.query('SELECT public.atualizar_ranking_semanal()')

5. üóÑÔ∏è 14:00:04 - PostgreSQL executa fun√ß√£o
   ‚îî‚îÄ atualizar_ranking_semanal()

6. üìÖ 14:00:05 - Calcula per√≠odo da semana
   ‚îî‚îÄ semana_inicio = '2025-09-15', semana_fim = '2025-09-21'

7. üóëÔ∏è 14:00:06 - Limpa ranking atual
   ‚îî‚îÄ DELETE FROM ranking_semanal WHERE semana_inicio = '2025-09-15'

8. üìä 14:00:07 - Consulta view para obter desempenho
   ‚îî‚îÄ SELECT * FROM vw_desempenho_alunos

9. üßÆ 14:00:08 - View calcula m√©tricas em tempo real
   ‚îî‚îÄ total_questoes, total_acertos, percentual_acerto, pontuacao_final

10. üìù 14:00:09 - Insere novos dados na tabela
    ‚îî‚îÄ INSERT INTO ranking_semanal (posicao, dados...)

11. ‚úÖ 14:00:10 - Fun√ß√£o retorna sucesso
    ‚îî‚îÄ RAISE NOTICE 'Ranking atualizado: 1 alunos'

12. üìà 14:00:11 - Node.js loga estat√≠sticas
    ‚îî‚îÄ await this.logEstatisticas()

13. üîì 14:00:12 - Libera execu√ß√£o
    ‚îî‚îÄ this.isRunning = false;

14. üéâ 14:00:13 - Job conclu√≠do
    ‚îî‚îÄ console.log('‚úÖ Ranking atualizado com sucesso em 1300ms')
```

## üéØ 5. Pontos de Monitoramento

### **N√≠vel de Aplica√ß√£o**
```javascript
// Logs de execu√ß√£o
console.log('‚è∞ Executando job de ranking (14:00)...');
console.log('‚úÖ Ranking atualizado com sucesso em 1300ms');

// Estat√≠sticas
console.log('üìä Estat√≠sticas do ranking:');
console.log('   ‚Ä¢ Total de alunos: 1');
console.log('   ‚Ä¢ Pontua√ß√£o m√©dia: 47.57');
console.log('   ‚Ä¢ Total de quest√µes: 9');
```

### **N√≠vel de Banco**
```sql
-- Logs PostgreSQL
RAISE NOTICE 'Ranking atualizado: % alunos, semana % a %', 
    v_posicao_atual - 1, v_semana_inicio, v_semana_fim;

RAISE NOTICE 'Ranking antigo limpo em %', CURRENT_TIMESTAMP;
```

### **N√≠vel de Dados**
```sql
-- Verifica√ß√£o manual
SELECT COUNT(*) as total_alunos, 
       AVG(pontuacao_final) as pontuacao_media
FROM ranking_semanal 
WHERE semana_inicio = DATE_TRUNC('week', CURRENT_DATE)::DATE;
```

## üöÄ 6. Vantagens do Fluxo

### **Separa√ß√£o de Responsabilidades**
- ‚úÖ **Aplica√ß√£o**: Agendamento e controle
- ‚úÖ **Banco**: C√°lculo e persist√™ncia
- ‚úÖ **Dados**: Consulta e performance

### **Performance**
- ‚úÖ **View otimizada** com √≠ndices
- ‚úÖ **C√°lculo em tempo real** no banco
- ‚úÖ **Jobs n√£o bloqueantes**
- ‚úÖ **Limpeza autom√°tica**

### **Manutenibilidade**
- ‚úÖ **C√≥digo modular** e organizado
- ‚úÖ **Logs detalhados** em cada n√≠vel
- ‚úÖ **F√°cil debug** e monitoramento
- ‚úÖ **Escal√°vel** para milhares de alunos

## üéØ 7. Resumo da "M√°gica"

A "m√°gica" acontece na **integra√ß√£o dos 3 n√≠veis**:

1. **Node.js** agenda e controla a execu√ß√£o
2. **PostgreSQL** calcula e persiste os dados
3. **View** fornece m√©tricas em tempo real

**Resultado**: Sistema autom√°tico, perform√°tico e escal√°vel que mant√©m o ranking sempre atualizado! üéØ

## üìä 8. Status Atual do Sistema

### **‚úÖ Implementado e Funcionando:**
- View `vw_desempenho_alunos` calculando corretamente
- Tabela `ranking_semanal` populada com dados reais
- Fun√ß√£o `atualizar_ranking_semanal()` executando sem erros
- API `/api/ranking` retornando dados corretos
- F√≥rmula de pontua√ß√£o aplicada: (acertos √ó 10) + (percentual √ó 0.5) + (quantidade √ó 0.1)

### **üîÑ Em Desenvolvimento:**
- Jobs automatizados com node-cron (comentados temporariamente)
- Scheduler para execu√ß√£o 3x ao dia
- Limpeza autom√°tica semanal

### **üìà Dados de Teste:**
- **1 aluno** no ranking: "Aluno teste"
- **9 quest√µes** totais, **3 acertos**
- **33.33%** de acerto
- **47.57 pontos** finais
- **Semana**: 15-21 de setembro de 2025

